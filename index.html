<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>אתגר היומיום</title>
  <style>
    body { font-family: Arial; text-align: center; padding: 50px; background-color: #f0f8ff; }
    h1,h2,h3 { color: #333; }
    #challenge { margin: 20px 0; font-size: 24px; font-weight: bold; }
    input { padding: 10px; margin: 5px; font-size: 16px; }
    button { padding: 10px 20px; font-size: 18px; cursor: pointer; margin: 5px; }
    #leaderboard { margin-top: 30px; }
    ol { text-align: left; display: inline-block; }
  </style>
</head>
<body>
  <h1>אתגר היומיום</h1>

  <div id="auth-container">
    <h2>התחבר / הירשם עם Google או אימייל</h2>
    <button onclick="signInWithGoogle()">התחבר עם Google</button>
    <hr>
    <input type="email" id="email" placeholder="אימייל">
    <input type="password" id="password" placeholder="סיסמה">
    <br>
    <button onclick="signUp()">הרשמה</button>
    <button onclick="signIn()">התחברות</button>
  </div>

  <div id="welcome" style="display:none;">
    <h2>ברוך הבא, <span id="username"></span>!</h2>
    <div id="challenge"></div>
    <button onclick="signOut()">התנתק</button>

    <div id="new-challenge" style="margin-top:20px;">
      <h3>העלה אתגר חדש</h3>
      <input type="text" id="challengeInput" placeholder="כתוב את האתגר שלך">
      <button onclick="submitChallenge()">שלח אתגר</button>
    </div>

    <div id="leaderboard">
      <h3>לוח ציונים</h3>
      <ol id="scoreList"></ol>
    </div>
  </div>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.5.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.5.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.5.0/firebase-firestore-compat.js"></script>

  <script>
    // ======================
    // Firebase Config
    // ======================
    const firebaseConfig = {
      apiKey: "AIzaSyC3mC1SpEqCcJ_3OV51P5dQafxhaBiNXMQ",
      authDomain: "challenge-app-1bcf5.firebaseapp.com",
      projectId: "challenge-app-1bcf5",
      storageBucket: "challenge-app-1bcf5.firebasestorage.app",
      messagingSenderId: "983360967243",
      appId: "1:983360967243:web:4d5335e561ebaa6c50b3ce",
      measurementId: "G-BLLYZLVGG4"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    // ======================
    // Google Sign-In
    // ======================
    function signInWithGoogle() {
      const provider = new firebase.auth.GoogleAuthProvider();
      auth.signInWithPopup(provider)
        .then(() => showWelcome())
        .catch(error => alert(error.message));
    }

    // ======================
    // Email/Password
    // ======================
    function signUp() {
      const email = document.getElementById('email').value;
      const password = document.getElementById('password').value;
      auth.createUserWithEmailAndPassword(email, password)
        .then(() => showWelcome())
        .catch(error => alert(error.message));
    }

    function signIn() {
      const email = document.getElementById('email').value;
      const password = document.getElementById('password').value;
      auth.signInWithEmailAndPassword(email, password)
        .then(() => showWelcome())
        .catch(error => alert(error.message));
    }

    // ======================
    // Common Functions
    // ======================
    function signOut() {
      auth.signOut().then(() => location.reload());
    }

    function showWelcome() {
      const user = auth.currentUser;
      document.getElementById('auth-container').style.display = 'none';
      document.getElementById('welcome').style.display = 'block';
      document.getElementById('username').textContent = user.displayName || user.email;
      loadTodaysChallenge();
      loadLeaderboard();
    }

    // ======================
    // Challenges
    // ======================
    function submitChallenge(){
      const text = document.getElementById('challengeInput').value;
      const user = auth.currentUser;
      if(!text) return alert("כתוב את האתגר!");
      db.collection("challenges").add({
        text: text,
        createdBy: user.uid,
        timestamp: firebase.firestore.FieldValue.serverTimestamp()
      }).then(() => {
        alert("האתגר נשלח!");
        document.getElementById('challengeInput').value='';
        loadTodaysChallenge();
      }).catch(err=>alert(err.message));
    }

    function loadTodaysChallenge(){
      db.collection("challenges").orderBy("timestamp").get()
        .then(snapshot => {
          const challenges = snapshot.docs.map(doc=>doc.data().text);
          if(challenges.length===0){
            document.getElementById('challenge').textContent = "טרם הועלו אתגרים";
            return;
          }
          const todayIndex = Math.floor((new Date() - new Date(new Date().getFullYear(),0,0))/1000/60/60/24) % challenges.length;
          document.getElementById('challenge').textContent = challenges[todayIndex];
        });
    }

    // ======================
    // Leaderboard
    // ======================
    function addPoints(points){
      const user = auth.currentUser;
      const userRef = db.collection("scores").doc(user.uid);
      userRef.get().then(doc=>{
        if(doc.exists){
          userRef.update({points: firebase.firestore.FieldValue.increment(points)});
        } else {
          userRef.set({points: points, name: user.displayName || user.email});
        }
        loadLeaderboard();
      });
    }

    function loadLeaderboard(){
      db.collection("scores").orderBy("points","desc").limit(10).get()
        .then(snapshot => {
          const list = document.getElementById('scoreList');
          list.innerHTML='';
          snapshot.docs.forEach(doc=>{
            const data = doc.data();
            const li = document.createElement('li');
            li.textContent = `${data.name}: ${data.points} נקודות`;
            list.appendChild(li);
          });
        });
    }

    // ======================
    // Monitor Auth State
    // ======================
    auth.onAuthStateChanged(user => {
      if(user) showWelcome();
    });

  </script>
</body>
</html>
